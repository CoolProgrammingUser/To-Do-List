<!DOCTYPE html>
<html>
    <head>
        <title>
            To-Do List
        </title>
        <script src="https://coolprogramminguser.github.io/Standards/behavior.js"></script>
        <script>
            var items = {};
            if (localStorage.getItem("To-Do-List")) {
                items = JSON.parse(localStorage.getItem("To-Do-List"));
            }
            localStorage.setItem("To-Do-List", JSON.stringify(items));
            var itemNumber = 1;
            var now = new Date();
            var week = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
            var Priority = function(description, importance, date, recurrence, lastFinished) {
                var then = date.split("~")[0].trim();
                var time = " " + date.split("~")[1].trim();
                function combine(array) {
                    return new Date(array.join(" ") + time);
                }
                switch (recurrence) {
                    case "once":
                        then = new Date([].concat(then.split("/")[2], then.split("/").slice(0,2)).join(" ")+time);
                        date = then.getMonth()+1 + "/" + then.getDate() + "/" + then.getFullYear() + time;
                        break;
                    case "monthly":
                        if (now.getDate() == then) {
                            if (now.getTime() <= combine([now.getFullYear(), now.getMonth()+1, then]).getTime()) {
                                then = combine([now.getFullYear(), now.getMonth()+1, then]);
                            } else {
                                if (now.getMonth() + 2 <= 12) {
                                    then = combine([now.getFullYear(), now.getMonth()+2, then]);
                                } else {
                                    then = combine([now.getFullYear()+1, 1, then]);
                                }
                            }
                        } else if (now.getDate() < then) {
                            then = new Date(now.getTime() + (then-now.getDate())*86400000);
                        } else {
                            if (now.getMonth() + 2 <= 12) {
                                then = combine([now.getFullYear(), now.getMonth()+2, then]);
                            } else {
                                then = combine([now.getFullYear()+1, 1, then]);
                            }
                        }
                        date = then.getMonth()+1 + "/" + then.getDate() + "/" + then.getFullYear() + time;
                        break;
                    case "weekly":
                        var closest = Infinity;
                        then.split(" ").forEach(function(weekday) {
                            var number = week.indexOf(weekday);
                            if (now.getDay() > number) {
                                number = 7 + number - now.getDay();
                            } else {
                                number -= now.getDay();
                            }
                            if (number < closest) {
                                closest = number;
                            }
                        });
                        closest += now.getDay();
                        if (closest > 6) {
                            closest -= 7;
                        }
                        if (now.getDay() == closest) {
                            if (now.getTime() <= combine([now.getFullYear(), now.getMonth()+1, now.getDate()]).getTime()) {
                                then = combine([now.getFullYear(), now.getMonth()+1, now.getDate()]);
                            } else {
                                closest = Infinity;
                                then.split(" ").forEach(function(weekday) {
                                    var number = week.indexOf(weekday);
                                    if (now.getDay() + 1 > number) {
                                        number = 6 + number - now.getDay();
                                    } else {
                                        number -= now.getDay() + 1;
                                    }
                                    if (number < closest) {
                                        closest = number;
                                    }
                                });
                                closest += now.getDay() + 1;
                                if (closest > 6) {
                                    closest -= 7;
                                }
                                if (now.getDay() < closest) {
                                    then = new Date(now.getTime() + (closest-now.getDay())*86400000);
                                } else {
                                    then = new Date(now.getTime() + (7+closest-now.getDay())*86400000);
                                }
                            }
                        } else if (now.getDay() < closest) {
                            then = new Date(now.getTime() + (closest-now.getDay())*86400000);
                        } else {
                            then = new Date(now.getTime() + (7+closest-now.getDay())*86400000);
                        }
                        date = then.getMonth()+1 + "/" + then.getDate() + "/" + then.getFullYear() + time;
                        break;
                    case "daily":
                        then = now;
                        break;
                }
                this.importance = importance;
                this.date = date.trim().split("~").join(" ");
                this.recurrence = recurrence;
                this.urgency = Math.round(Math.abs(then.getTime()-now.getTime())/1000*(20-importance));
                var checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = "item" + itemNumber;
                checkbox.style.margin = ".5em";
                itemNumber++;
                var label = document.createElement("label");
                label.for = checkbox.id;
                label.title = "Due: {0}\nImportance: {1}".format(["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][then.getDay()]+", "+this.date, this.importance);
                label.innerHTML = description;
                if (recurrence != "daily" && then.getTime()-now.getTime() > 0) {
                    var later;
                    if (now.getHours() < 8) {  // if the current time is before 8:00am
                        later = new Date(new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() + 86400000);
                    } else {
                        later = new Date(new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() + 172800000);
                    }
                    if (then.getTime() < later.getTime()) {
                        label.style.fontWeight = "bold";
                        label.innerHTML = "<mark>" + label.innerHTML + "</mark>";
                    } else if (then.getTime() < later.getTime() + 86400000) {
                        label.innerHTML = "<mark style='background:#ffff88'>" + label.innerHTML + "</mark>";
                    }
                }
                if (then.getTime() - now.getTime() < 0) {
                    label.style.fontWeight = "bold";
                    label.style.color = "red";
                }
                var elements = document.createElement("div");
                elements.appendChild(checkbox);
                elements.appendChild(label);
                this.elements = elements;
                checkbox.addEventListener("click", function() {
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                        label.style.fontWeight = "inherit";
                        if (label.children.length > 0) {
                            label.children[0].style.background = "inherit";
                        }
                    } else {
                        refresh();
                    }
                });
                var increment = 0;
                while(Priority.instances[this.urgency+increment] != undefined) {
                    // while there's a target key value already taken, increase the target key by 1
                    // (prevents overwriting when things have the same due-date and importance)
                    increment++;
                });
                Priority.instances[this.urgency+increment] = this;
            }
            Priority.instances = {};
            
            function include() {
                var description = getId("description").value.trim();
                var date;
                var time = getId("time").value.trim() + (getId("timeFormat").value!="24-hour" ? " "+getId("timeFormat").value : "");
                if (getId("fullDate").value) {
                    if (getId("fullDate").value.includes("/")) {
                        date = getId("fullDate").value;
                    } else {  // if it's a day of the week
                        var then = getId("fullDate").value;
                        then = week.indexOf(then.toLowerCase());
                        if (now.getDay() == then) {
                           if (now.getTime() <= new Date([now.getFullYear(), now.getMonth()+1, now.getDate()].join(" ")+" "+time).getTime()) {
                                date = now.getMonth() + 1 + "/" + now.getDate() + "/" + now.getFullYear();
                            } else {
                                then = new Date(now.getTime() + 604800000);
                                date = then.getMonth() + 1 + "/" + then.getDate() + "/" + then.getFullYear();
                            }
                        } else if (now.getDay() < then) {
                            then = new Date(now.getTime() + (then-now.getDay())*86400000);
                            date = then.getMonth() + 1 + "/" + then.getDate() + "/" + then.getFullYear();
                        } else {
                            then = new Date(now.getTime() + (7+then-now.getDay())*86400000);
                            date = then.getMonth() + 1 + "/" + then.getDate() + "/" + then.getFullYear();
                        }
                    }
                } else if (getId("day").value) {
                    date = getId("day").value;
                } else {
                    date = "";
                    week.forEach(function(ID) {
                        if (getId(ID).checked) {
                            date += ID + " ";
                        }
                    });
                    date.trim();
                }
                date += "~" + time;
                items[description] = {"importance":getId("importance").value, "time":date, "recurrence":getId("recurrence").value};
                localStorage.setItem("To-Do-List", JSON.stringify(items));
                getId("description").value = "";
                getId("importance").value = "";
                getId("recurrence").value = "";
                getId("fullDate").value = "";
                getId("quickSelect").value = "";
                getId("day").value = "";
                week.forEach(function(ID) {
                    getId(ID).checked = false;
                });
                getId("time").value = "";
                getId("timeFormat").value = "";
                getId("once").style.display = "none";
                getId("monthly").style.display = "none";
                getId("weekly").style.display = "none";
                refresh();
            }
            function refresh() {
                getId("list").innerHTML = "";
                Priority.instances = {};
                items.forEach(function(value, key) {
                    new Priority(key, value.importance, value.time, value.recurrence);
                });
                console.log(Priority.instances);
                Priority.instances.forEach(function(instance) {
                    getId("list").appendChild(instance.elements);
                    getId("list").appendChild(document.createElement("br"));
                });
                if (getId("list").innerHTML == "") {
                    getId("list").innerHTML = "<p>Add some things to do.</p>";
                }
            }
            
            window.addEventListener("finished", function() {
                refresh();
                getId("recurrence").addEventListener("change", function() {
                    switch (this.value) {
                        case "once":
                            getId("monthly").style.display = "none";
                            getId("weekly").style.display = "none";
                            getId("once").style.display = "inline-block";
                            break;
                        case "monthly":
                            getId("once").style.display = "none";
                            getId("weekly").style.display = "none";
                            getId("monthly").style.display = "inline-block";
                            break;
                        case "weekly":
                            getId("once").style.display = "none";
                            getId("monthly").style.display = "none";
                            getId("weekly").style.display = "inline-block";
                            break;
                        case "daily":
                            getId("once").style.display = "none";
                            getId("monthly").style.display = "none";
                            getId("weekly").style.display = "none";
                            break;
                    }
                });
                getId("quickSelect").addEventListener("change", function() {
                    getId("fullDate").value = this.value;
                });
                getId("remove").addEventListener("click", function() {
                    items.forEach(function(value, key) {
                        if (key == getId("description").value.trim()) {
                            delete items[key];
                            return "break";
                        }
                    });
                    Priority.instances.forEach(function(instance, index) {
                        if (instance.description == getId("description").value.trim()) {
                            Priority.instances.splice(index, 1);
                            return "break";
                        }
                    });
                    localStorage.setItem("To-Do-List", JSON.stringify(items));
                    getId("description").value = "";
                    refresh();
                });
                setInterval(refresh, 1000000);
            });
        </script>
    </head>
    <body>
        <div id="list" class="list"></div>
        <br>
        <br>
        <input type="text" id="description" placeholder="Thing to do">
        <br>
        <br>
        <select id="importance">
            <option value="" disabled selected>
                Importance
            </option>
            <option value="1">
                1 (lowest)
            </option>
            <option value="2">
                2
            </option>
            <option value="3">
                3
            </option>
            <option value="4">
                4
            </option>
            <option value="5">
                5 (highest)
            </option>
        </select>
        <br>
        <br>
        <select id="recurrence">
            <option value="" disabled selected>
                Recurrence
            </option>
            <option value="once">
                One time
            </option>
            <option value="monthly">
                Monthly
            </option>
            <option value="weekly">
                Weekly
            </option>
            <option value="daily" disabled>
                Daily
            </option>
        </select>
        <br>
        <div id="once" style="display:none">
            <br>
            <input type="text" id="fullDate" placeholder="Date (month/day/year)">
            <select id="quickSelect">
                <option value="" disabled selected>
                    Quick select
                </option>
                <option value="monday">
                    Monday
                </option>
                <option value="tuesday">
                    Tuesday
                </option>
                <option value="wednesday">
                    Wednesday
                </option>
                <option value="thursday">
                    Thursday
                </option>
                <option value="friday">
                    Friday
                </option>
                <option value="saturday">
                    Saturday
                </option>
                <option value="sunday">
                    Sunday
                </option>
            </select>
            <br>
            <br>
        </div>
        <div id="monthly" style="display:none">
            <br>
            <input type="text" id="day" placeholder="Day of the month">
            <br>
            <br>
        </div>
        <div id="weekly" class="list" style="display:none">
            <br>
            <input type="checkbox" id="monday">
            <label for="monday">Monday</label>
            <br>
            <input type="checkbox" id="tuesday">
            <label for="tuesday">Tuesday</label>
            <br>
            <input type="checkbox" id="wednesday">
            <label for="wednesday">Wednesday</label>
            <br>
            <input type="checkbox" id="thursday">
            <label for="thursday">Thursday</label>
            <br>
            <input type="checkbox" id="friday">
            <label for="friday">Friday</label>
            <br>
            <input type="checkbox" id="saturday">
            <label for="saturday">Saturday</label>
            <br>
            <input type="checkbox" id="sunday">
            <label for="sunday">Sunday</label>
            <br>
            <br>
        </div>
        <br>
        <input type="text" id="time" placeholder="Time (hour:minute)">
        <select id="timeFormat">
            <option value="" disabled selected>
                Time format
            </option>
            <option value="am">
                am
            </option>
            <option value="pm">
                pm
            </option>
            <option value="24-hour">
                24-hour
            </option>
        </select>
        <br>
        <br>
        <button onclick="include()">
            Add to list
        </button>
        <button id="remove">
            Remove
        </button>
        <h2 style="display:none">
            Past Due
        </h2>
        <ul id="pastDue"></ul>
    </body>
</html>
