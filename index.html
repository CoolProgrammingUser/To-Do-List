<!doctype html>
<html>
	<head>
		<title>
			To-do List
		</title>
		<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase-firestore.js"></script>
		<script src="https://epicenterprograms.github.io/standards/behavior/firebaseinit.js"></script>
		<script src="https://epicenterprograms.github.io/standards/behavior/general.js"></script>
		<!--
		<script src="file:///C:/Users/Robert/Documents/GitHub/standards/behavior/general.js"></script>
		-->
		<script>
			var S = Standards.general;
			S.storage.session.defaultLocation = "lists/default";
			S.storage.local.defaultLocation = "lists/default";
			S.storage.server.defaultLocation = "lists/default/items";

			var itemNumber = 1;
			var now = new Date();
			var week = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
			var dayThreshold = 8;
			var mergeData = false;
			var deleteData = false;
			var listenable = new S.Listenable();
			var pastDueNumber = 0;
			var dueTodayNumber = 0;
			var storagePlace = "local";
			var noisemaker;

			var sampleList = [
				{
					description: "finish my math homework",
					importance: 4,
					recurrence: "weekly",
					time: "monday wednesday friday~11:59 pm",
					lastFinished: now.getTime(),
					done: false
				},
				{
					description: "go to work",
					importance: 4,
					recurrence: "weekly",
					time: "monday tuesday wednesday thursday friday~4:00 pm",
					lastFinished: now.getTime(),
					done: false
				},
				{
					description: "brush my teeth",
					importance: 3,
					recurrence: "daily",
					time: "~10:30 pm",
					lastFinished: now.getTime(),
					done: false,
					labels: ["sanitary"]
				},
				{
					description: "cut the grass",
					importance: 1,
					recurrence: "indefinite",
					time: now.getTime() + 700000000 + "~",
					lastFinished: now.getTime(),
					done: false
				},
				{
					description: "go to Joe's party",
					importance: 2,
					recurrence: "once",
					time: function () {
						let time = new Date(now.getTime() + 345600000);
						return (time.getMonth()+1) + "/" + time.getDate() + "/" + time.getFullYear() + "~8:00 pm";
					}(),
					lastFinished: now.getTime(),
					done: false,
					labels: ["fun"]
				},
				{
					description: "take out the trash",
					importance: 3,
					recurrence: "weekly",
					time: "friday~7:00 pm",
					lastFinished: now.getTime(),
					done: true,
					labels: ["sanitary"]
				},
				{
					description: "have game night",
					importance: 2,
					recurrence: "monthly",
					time: "10~8:00 pm",
					lastFinished: now.getTime(),
					done: false,
					labels: ["fun"]
				},
				{
					description: "sign up for the charity event",
					importance: 2,
					recurrence: "once",
					time: function () {
						let time = new Date(now.getTime() - 86400000);
						return (time.getMonth() + 1) + "/" + time.getDate() + "/" + time.getFullYear() + "~5:00 pm";
					}(),
					lastFinished: now.getTime()-172800000,
					done: false
				},
				{
					description: "find my keys",
					importance: 5,
					recurrence: "indefinite",
					time: now.getTime() + "~",
					lastFinished: now.getTime(),
					done: true
				},
				{
					description: "have breakfast with Sally",
					importance: 3,
					recurrence: "once",
					time: ((now.getMonth()>10 ? 0 : now.getMonth()+1)+1) + "/" + (now.getDate()+1) + "/" + (now.getMonth()>10 ? now.getFullYear()+1 : now.getFullYear()) + "~8:00 am",
					lastFinished: now.getTime(),
					done: false,
					labels: ["fun"]
				}
			];

			function makePriority(description, importance, date, recurrence, lastFinished, done, labels) {
				/**
				adds a priority to Priority.instances
				*/
				
				// makes a Date object for the due date (assigned to "then")
				var originalDate = date;
				var then = date.split("~")[0].trim();
				var time = " " + date.split("~")[1].trim();
				function combine(array) {
					return new Date(array.join(" ") + time);
				}
				now = new Date(Number(lastFinished));  //// This should use a different variable than "now", but I used "now" too many times in the following part.
				switch (recurrence) {  // sets the exact time of the (next) event
					case "indefinite":
						then = new Date(Number(then));  // Number() is needed because "then" is a string
						// "date" can't also be set here because it causes the due time displayed to always be what it was originally
						break;
					case "once":
						then = new Date([].concat(then.split("/")[2], then.split("/").slice(0,2)).join(" ")+time);
						date = then.getMonth()+1 + "/" + then.getDate() + "/" + then.getFullYear() + time;
						break;
					case "monthly":
						if (now.getDate() == then) {
							if (now.getTime() <= combine([now.getFullYear(), now.getMonth()+1, then]).getTime()) {
								then = combine([now.getFullYear(), now.getMonth()+1, then]);
							} else {
								if (now.getMonth() + 2 <= 12) {
									then = combine([now.getFullYear(), now.getMonth()+2, then]);
								} else {
									then = combine([now.getFullYear()+1, 1, then]);
								}
							}
						} else if (now.getDate() < then) {
							then = new Date(now.getTime() + (then-now.getDate())*86400000);
						} else {
							if (now.getMonth() + 2 <= 12) {
								then = combine([now.getFullYear(), now.getMonth()+2, then]);
							} else {
								then = combine([now.getFullYear()+1, 1, then]);
							}
						}
						date = then.getMonth()+1 + "/" + then.getDate() + "/" + then.getFullYear() + time;
						break;
					case "weekly":
						let closest = Infinity;
						then.split(" ").forEach(function(weekday) {
							let number = week.indexOf(weekday);
							if (now.getDay() > number) {
								number = 7 + number - now.getDay();
							} else {
								number -= now.getDay();
							}
							if (number < closest) {
								closest = number;
							}
						});
						closest += now.getDay();
						if (closest > 6) {
							closest -= 7;
						}
						if (now.getDay() == closest) {
							if (now.getTime() <= combine([now.getFullYear(), now.getMonth()+1, now.getDate()]).getTime()) {
								then = combine([now.getFullYear(), now.getMonth()+1, now.getDate()]);
							} else {
								closest = Infinity;
								then.split(" ").forEach(function(weekday) {
									let number = week.indexOf(weekday);
									if (now.getDay() + 1 > number) {
										number = 6 + number - now.getDay();
									} else {
										number -= now.getDay() + 1;
									}
									if (number < closest) {
										closest = number;
									}
								});
								closest += now.getDay() + 1;
								if (closest > 6) {
									closest -= 7;
								}
								if (now.getDay() < closest) {
									then = new Date(now.getTime() + (closest-now.getDay())*86400000);
									then = combine([then.getFullYear(), then.getMonth()+1, then.getDate()]);
								} else {
									then = new Date(now.getTime() + (7+closest-now.getDay())*86400000);
									then = combine([then.getFullYear(), then.getMonth()+1, then.getDate()]);
								}
							}
						} else if (now.getDay() < closest) {
							then = new Date(now.getTime() + (closest-now.getDay())*86400000);
							then = combine([then.getFullYear(), then.getMonth()+1, then.getDate()]);
						} else {
							then = new Date(now.getTime() + (7+closest-now.getDay())*86400000);
							then = combine([then.getFullYear(), then.getMonth()+1, then.getDate()]);
						}
						date = then.getMonth()+1 + "/" + then.getDate() + "/" + then.getFullYear() + time;
						break;
					case "daily":
						then = combine([now.getFullYear(), now.getMonth()+1, now.getDate()]);
						if (now.getTime() > then.getTime()) {
							then = new Date(then.getTime()+86400000);
						}
						date = then.getMonth()+1 + "/" + then.getDate() + "/" + then.getFullYear() + time;
						break;
				}
				
				// sets the urgency of the item
				now = new Date();  //// This sets "now" back to representing what it's supposed to.
				if (recurrence == "indefinite") {
					date = then.getTime() - now.getTime();
					if (date <= 0) {
						date = "Immediately";
					} else if (date <= 250000000) {
						date = "Soon";
					} else if (date <= 700000000) {
						date = "Later";
					} else if (date <= 1600000000) {
						date = "In a while";
					} else {
						date = "At some point";
					}
					var urgency = (then.getTime()-now.getTime())/1000;
					if (urgency < 54000) {  // Negative numbers will put it at the end, not the top.
						urgency = 54000;  // This causes indefinite items to effectively never be any closer than 15 hours away.
					}
					urgency = Math.round(urgency * (10-importance))
				} else if (recurrence == "daily") {
					var urgency = Math.round(Math.abs(then.getTime()-now.getTime())/100*(10-importance));
				} else {
					var urgency = Math.round(Math.abs(then.getTime()-now.getTime())/1000*(10-importance));
				}
				
				// creates the HTML objects to be displayed
				let checkbox = document.createElement("input");
				checkbox.type = "checkbox";
				checkbox.id = "item" + itemNumber;
				itemNumber++;
				let label = document.createElement("span");
				if (recurrence == "indefinite") {
					label.title = "Due: {0}\nImportance: {1}".format(date, importance);
				} else {
					if (then.getTime() - now.getTime() < 86400000) {
						label.title = "Due:{0}\nImportance: {1}".format(time, importance);
					} else if (then.getTime() - now.getTime() < 518400000) {
						label.title = "Due: {0}\nImportance: {1}".format(["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][then.getDay()]+time, importance);
					} else {
						label.title = "Due: {0}\nImportance: {1}".format(["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][then.getDay()]+", "+date, importance);
					}
				}
				label.innerHTML = decodeURIComponent(description);
				
				// sets label highlighting
				if (then.getTime() >= now.getTime() || recurrence == "indefinite") {
					let later;
					if (recurrence == "indefinite") {
						if (then.getTime() <= now.getTime()) {
							label.style.fontWeight = "bold";
							if (importance == 5) {
								label.style.textDecoration = "underline";
							} else if (importance == 4) {
								label.style.WebkitTextDecorationStyle = "dotted";  // for Safari
								label.style.textDecoration = "underline dotted";
							}
							label.innerHTML = "<mark style='background:#00ff00'>" + label.innerHTML + "</mark>";
						} else if (then.getTime() - now.getTime() < (then.getTime()-lastFinished) / 3) {
							label.innerHTML = "<mark style='background:#88ff88'>" + label.innerHTML + "</mark>";
						}
					} else if (recurrence == "daily") {
						if (then.getTime() - now.getTime() < 10800000) {  // if it's closer than 3 hours away
							label.style.fontWeight = "bold";
							if (importance == 5) {
								label.style.textDecoration = "underline";
							} else if (importance == 4) {
								label.style.WebkitTextDecorationStyle = "dotted";
								label.style.textDecoration = "underline dotted";
							}
							label.innerHTML = "<mark style='background:#ff00ff'>" + label.innerHTML + "</mark>";
						} else if (then.getTime() - now.getTime() < 21600000) {  // if it's closer than 6 hours away
							label.innerHTML = "<mark style='background:#ff88ff'>" + label.innerHTML + "</mark>";
						}
					} else {
						////////////////////////////////////////// setting the due-today number should be done somewhere around here
						if (now.getHours() < dayThreshold) {  // if the current time is before the day threshold (defaults to 8:00am)
							later = new Date(new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() + 86400000);
						} else {
							later = new Date(new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() + 172800000);
						}
						if (then.getTime() < later.getTime()) {
							label.style.fontWeight = "bold";
							if (importance == 5) {
								label.style.textDecoration = "underline";
							} else if (importance == 4) {
								label.style.WebkitTextDecorationStyle = "dotted";
								label.style.textDecoration = "underline dotted";
							}
							label.innerHTML = "<mark>" + label.innerHTML + "</mark>";
						} else if (then.getTime() < later.getTime() + 86400000) {
							label.innerHTML = "<mark style='background:#ffff88'>" + label.innerHTML + "</mark>";
						}
					}
				} else {
					label.style.fontWeight = "bold";
					if (importance == 5) {
						label.style.textDecoration = "underline solid red";
					} else if (importance == 4) {
						label.style.WebkitTextDecorationStyle = "dotted";
						label.style.textDecoration = "underline dotted red";
					}
					label.style.color = "red";
					label.title = "Past due";
					pastDueNumber++;
				}
				
				// puts the elements into a container
				let section = document.createElement("section");
				section.className = "list-item";
				section.appendChild(checkbox);
				section.appendChild(label);
				let elements = document.createElement("div");
				elements.appendChild(section);
				
				// crosses out finished items
				if (done) {
					if (then.getTime() < now.getTime() && recurrence != "indefinite") {
						pastDueNumber--;
					}
					label.style.textDecoration = "line-through";
					label.title = "Finished";
					label.style.color = "inherit";
					label.style.fontWeight = "inherit";
					if (label.children.length > 0) {  // if there's a <mark> tag
						label.children[0].style.background = "inherit";
					}
					if (recurrence != "indefinite" && recurrence != "once" && now.getTime() > then.getTime()) {
						lastFinished = then.getTime() + 1;
						done = false;
						let item = S.storage[storagePlace].recall(description);
						item.lastFinished = lastFinished;
						item.done = done;
						S.storage[storagePlace].store(description, item);
						var needsToRunFunctionAgain = true;
					}
				}
				/*
				if (done) {
					function handler(mutations, observer) {
						mutations.forEach(function(mutation) {
							mutation.addedNodes.forEach(function(node) {
								if (node == checkbox) {
									checkbox.check();
									watcher.disconnect();
								}
							});
						});
					}
					var watcher = new MutationObserver(handler) || webkitMutationObserver(handler);
					watcher.observe(getId("list"), {"childList":true, "subtree":true});
				}
				*/
				
				// adds the item to the priority list or runs the function again
				if (needsToRunFunctionAgain) {
					makePriority(description, importance, originalDate, recurrence, lastFinished, done, labels);
				} else {
					if (isNaN(urgency) || S.getType(urgency) != "Number") {
						throw 'The item with the description "' + decodeURIComponent(description) + '" has a non-number urgency.';
					}
					let increment = 0;
					while (Priority.instances[urgency + increment] != undefined) {
						// while there's a target key value already taken, increase the target key by 1
						// (prevents overwriting when things have the same due-date and importance)
						increment++;
					}
					Priority.instances[urgency+increment] = {description: decodeURIComponent(description), done: done, elements: elements.innerHTML, labels: labels};
				}
			}
			Priority = {instances: {}};
			
			function include() {
				let enoughInformation = true;
				if (!(S.getId("description").value.trim() && S.getId("importance").value && S.getId("recurrence").value)) {
					enoughInformation = false;
				} else {
					if (S.getId("recurrence").value == "indefinite") {
						if (!S.getId("timeframe").value) {
							enoughInformation = false;
						}
					} else {
						if (!S.getId("time").value) {
							enoughInformation = false;
						}
					}
				}
				if (enoughInformation) {
					now = new Date();
					let description = encodeURIComponent(S.getId("description").value.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;"));
					let date = "";
					let time = S.getId("time").value.trim() + (S.getId("timeFormat").value!="24-hour" ? " "+S.getId("timeFormat").value : "");
					switch (S.getId("recurrence").value) {
						case "indefinite":
							switch (S.getId("timeframe").value) {  // sets when the highlight will become most apparent
								case "immediately":
									date = now.getTime();  // now
									break;
								case "soon":
									date = now.getTime() + 250000000;  // in a little less than 3 days
									break;
								case "later":
									date = now.getTime() + 700000000;  // in a little more than 8 days
									break;
								case "aWhile":
									date = now.getTime() + 1600000000;  // in about 18.5 days
									break;
								case "somePoint":
									date = now.getTime() + 3628800000;  // in exactly 42 days
									break;
							}
							break;
						case "once":
							if (S.getId("fullDate").value.includes("/")) {
								date = S.getId("fullDate").value;
							} else {  // if it's a day of the week
								var then = S.getId("fullDate").value;
								then = week.indexOf(then.toLowerCase());
								if (now.getDay() == then) {
								   if (now.getTime() <= new Date([now.getFullYear(), now.getMonth()+1, now.getDate()].join(" ")+" "+time).getTime()) {
										date = now.getMonth() + 1 + "/" + now.getDate() + "/" + now.getFullYear();
									} else {
										then = new Date(now.getTime() + 604800000);
										date = then.getMonth() + 1 + "/" + then.getDate() + "/" + then.getFullYear();
									}
								} else if (now.getDay() < then) {
									then = new Date(now.getTime() + (then-now.getDay())*86400000);
									date = then.getMonth() + 1 + "/" + then.getDate() + "/" + then.getFullYear();
								} else {
									then = new Date(now.getTime() + (7+then-now.getDay())*86400000);
									date = then.getMonth() + 1 + "/" + then.getDate() + "/" + then.getFullYear();
								}
							}
							break;
						case "monthly":
							date = S.getId("day").value;
							break;
						case "weekly":
							let numberChecked = 0;
							week.forEach(function(ID) {
								if (S.getId(ID).checked) {
									date += ID + " ";
									numberChecked++;
								}
							});
							if (numberChecked == 0) {  //// This checking should integrate with enoughInformation.
								alert("You need to check at least one day of the week.");
								return;
							}
							date.trim();
							break;
					}
					date += "~" + time;
					// sets labels
					let labels = S.getId("labels").value.trim().split(",");
					S.forEach(labels, function (label, index) {
						labels[index] = label.trim();
					});
					// stores the information
					S.storage[storagePlace].store(description, { importance: S.getId("importance").value, time: date, recurrence: S.getId("recurrence").value, lastFinished: now.getTime(), done: false, labels: labels });
					// resets stuff
					["description", "importance", "recurrence", "timeframe", "fullDate", "quickSelect", "day", "time", "timeFormat", "labels"].forEach(function(ID) {
						S.getId(ID).value = "";
					});
					week.forEach(function(ID) {
						S.getId(ID).checked = false;
					});
					["indefinite", "once", "monthly", "weekly", "timeSection"].forEach(function(ID) {
						S.getId(ID).style.display = "none";
					});
					// refreshes the list
					refresh();
					setTimeout(function () {
						refresh(true);
					}, 0);
					// randomly displays inspiring messages (if desired)
					if (S.getId("inspiringMessages").checked && Math.floor(Math.random()*5) == 0) {
						let messages = ["You're the best!", "You're worth it.", "Nothing can stop you.", "You rock!", "You're an amazing person.", "The world wouldn't be the same without you.", "I love you."];
						S.makeDialog(messages[Math.floor(Math.random()*messages.length)], "Thank you");
					}
				} else {
					alert("You left out at least one field.");
				}
			}
			function showHide() {
				switch (S.getId("recurrence").value) {
					case "indefinite":
						S.getId("once").style.display = "none";
						S.getId("weekly").style.display = "none";
						S.getId("monthly").style.display = "none";
						S.getId("timeSection").style.display = "none";
						S.getId("indefinite").style.display = "block";
						break;
					case "once":
						S.getId("indefinite").style.display = "none";
						S.getId("monthly").style.display = "none";
						S.getId("weekly").style.display = "none";
						S.getId("once").style.display = "block";
						S.getId("timeSection").style.display = "block";
						break;
					case "monthly":
						S.getId("indefinite").style.display = "none";
						S.getId("once").style.display = "none";
						S.getId("weekly").style.display = "none";
						S.getId("monthly").style.display = "block";
						S.getId("timeSection").style.display = "block";
						break;
					case "weekly":
						S.getId("indefinite").style.display = "none";
						S.getId("once").style.display = "none";
						S.getId("monthly").style.display = "none";
						S.getId("weekly").style.display = "table";
						S.getId("timeSection").style.display = "block";
						break;
					case "daily":
						S.getId("indefinite").style.display = "none";
						S.getId("once").style.display = "none";
						S.getId("monthly").style.display = "none";
						S.getId("weekly").style.display = "none";
						S.getId("timeSection").style.display = "block";
						break;
					default:
						S.getId("indefinite").style.display = "none";
						S.getId("once").style.display = "none";
						S.getId("monthly").style.display = "none";
						S.getId("weekly").style.display = "none";
						S.getId("timeSection").style.display = "none";
						break;
				}
			}

			function mergeInformation(localTakesPrecedence) {
				////
				now = new Date();
				S.getId("list").innerHTML = "<p>Syncing your data...</p>";
				Priority.instances = {};
				pastDueNumber = 0;
				dueTodayNumber = 0;
				////
				if (localTakesPrecedence) {  // if the local information should be given precedence over the server information
					listenable.value = 0;
					listenable.addEventListener("change", function (value) {
						if (value >= S.storage[storagePlace].list().length) {  // when all items have been stored
							listenable.removeEventListener("change", arguments.callee);
							listenable.value = undefined;
							S.storage.server.list("", function (list) {
								let localKeys = S.storage[storagePlace].list();
								listenable.value = 0;
								listenable.addEventListener("set", function (itemsLeft) {
									if (itemsLeft == 0) {
										listenable.removeEventListener("set", arguments.callee);
										window.dispatchEvent(new Event("readyToRefresh"));
									}
								});
								if (list.length > 0) {
									// deletes account data not not present in the current data
									let deleting = false;
									S.forEach(list, function (document) {
										if (!localKeys.includes(document.id)) {
											deleting = true;
											listenable.value++;
											S.storage.server.forget(document.id, "", function () {
												listenable.value--;
											});
										}
									});
									if (!deleting) {
										listenable.value = 0;
									}
								} else {
									window.dispatchEvent(new Event("readyToRefresh"));
								}
							});
						}
					});
					if (S.storage[storagePlace].list().length > 0) {
						// stores and replaces account data with current data
						S.forEach(S.storage[storagePlace].list(), function (key) {
							S.storage.server.store(key, S.storage[storagePlace].recall(key), "", function () {
								listenable.value++;
							});
						});
					} else {
						listenable.value++;
					}
				} else {  // if the server information should be given precedence over the local information
					S.storage.server.list("", function (list) {
						listenable.addEventListener("change", function (index) {
							S.storage.server.recall(list[index].id, "", function (data) {
								S.storage[storagePlace].store(list[index].id, data);
								if (index + 1 >= list.length) {
									let idList = [];
									S.forEach(list, function (document) {
										idList.push(document.id);
									});
									S.forEach(S.storage[storagePlace].list(), function (key) {
										if (!idList.includes(key)) {
											S.storage[storagePlace].forget(key);
										}
									});
									window.dispatchEvent(new Event("readyToRefresh"));
								}
							});
							if (index + 1 < list.length) {
								listenable.value++;
							} else {
								listenable.removeEventListener("change", arguments.callee);
							}
						});
						listenable.value = 0;
					});
				}
				S.getClass("drop-down")[0].children[1].style.display = "none";
			}

			function refresh(shouldSync) {
				now = new Date();
				S.getId("list").innerHTML = "<p>Syncing your data...</p>";
				Priority.instances = {};
				pastDueNumber = 0;
				dueTodayNumber = 0;
				// syncs data if desired and possible
				if (shouldSync && S.getId("syncData").checked && S.storage.server.user) {
					/*
					if (mergeData) {  // if the existing data should be merged to the account data
						mergeInformation(true);
					} else {
						useLocal = false;
						// stores and replaces current session data with account data
						S.storage.server.list("", function (list) {
							listenable.addEventListener("change", function (index) {
								S.storage.server.recall(list[index].id, "", function (data) {
									S.storage.session.store(list[index].id, data);
									if (index + 1 >= list.length) {
										window.dispatchEvent(new Event("readyToRefresh"));
									}
								});
								if (index + 1 < list.length) {
									listenable.value++;
								} else {
									listenable.removeEventListener("change", arguments.callee);
								}
							});
							listenable.value = 0;
						});
					}
					*/
				} else {
					window.dispatchEvent(new Event("readyToRefresh"));
				}
			}
			S.listen(window, "readyToRefresh", function () {
				S.getId("list").innerHTML = "";
				// fills Priority.instances
				S.storage[storagePlace].list().forEach(function (key) {
					let item = S.storage[storagePlace].recall(key);
					makePriority(key, item.importance, item.time, item.recurrence, item.lastFinished, item.done, item.labels);
				});
				// declares necessary variables
				let list = [],
					currentIndex = 0,
					alreadyCounted = [];
				// puts items from the Priority.instances object into an array
				S.forEach(Priority.instances, function (item) {
					// allows filtering items
					if (S.getId("listFilter").value.trim()) {
						let labelsToInclude = S.getId("listFilter").value.trim().split(",");
						S.forEach(labelsToInclude, function (label, index) {
							labelsToInclude[index] = label.trim();
						});
						if (item.labels && item.labels.some(function (label) {
							return labelsToInclude.includes(label);
						})) {
							list.push(item);
						}
					} else {
						list.push(item);
					}
				});
				// moves finished items to the end
				while (currentIndex < list.length && alreadyCounted.indexOf(list[currentIndex].description) == -1) {
					if (list[currentIndex].done) {
						alreadyCounted.push(list[currentIndex].description);
						list.move(currentIndex);
					} else {
						currentIndex++;
					}
				}
				// inserts the items onto the page
				let HTML = "";
				list.forEach(function (instance) {
					HTML += instance.elements;
				});
				S.getId("list").innerHTML = HTML;
				// checks off finished checkboxes
				list.forEach(function (instance, index) {
					if (instance.done) {
						S.getId("list").getElementsByTagName("input")[index].checked = true;
					}
				});
				// adds a notification of past-due items
				if (pastDueNumber > 0) {
					S.getId("pastDueNotifier").textContent = pastDueNumber;
					S.getId("pastDueNotifier").style.display = "inline-block";
				} else {
					S.getId("pastDueNotifier").style.display = "none";
				}
				S.getId("pastDueItems").textContent = pastDueNumber;
				// adds an indicator of what's due the same day
				S.getId("dueTodayItems").textContent = "_"  //// dueTodayNumber;

				if (S.getId("list").innerHTML == "") {
					// adds a prompt if there's no items saved
					S.getId("list").innerHTML = "<p>Add some things to do.</p>";
				} else {
					// sets list item listeners
					list.forEach(function (listItem, index) {
						// listens for clicking on a checkbox
						// (toggles the item's "done" property)
						S.listen(S.getId("list").getElementsByTagName("input")[index], "click", function () {
							let item = S.storage[storagePlace].recall(encodeURIComponent(listItem.description));
							if (this.checked) {
								item.done = true;
							} else {
								item.done = false;
							}
							S.storage[storagePlace].store(encodeURIComponent(listItem.description), item);
							refresh();
						});
						// listens for double-clicking on a description
						// (pulls up the editor for that item)
						S.listen(S.getId("list").getElementsByTagName("span")[index], "dblclick", function () {
							// prevents highlighting the text when double-clicking
							// event.preventDefault() would only work with onmousedown
							if (document.selection && document.selection.empty) {
								document.selection.empty();
							} else if (window.getSelection) {
								window.getSelection().removeAllRanges();
							}
							let item = S.storage[storagePlace].recall(encodeURIComponent(listItem.description));
							S.getId("description").value = listItem.description;
							S.getId("importance").value = item.importance;
							S.getId("recurrence").value = item.recurrence;
							switch (item.recurrence) {
								case "indefinite":
									let indefiniteTime = Number(item.time.split("~")[0]) - now.getTime();
									if (indefiniteTime <= 0) {
										indefiniteTime = "immediately";
									} else if (indefiniteTime <= 250000000) {
										indefiniteTime = "soon";
									} else if (indefiniteTime <= 700000000) {
										indefiniteTime = "later";
									} else if (indefiniteTime <= 1600000000) {
										indefiniteTime = "aWhile";
									} else {
										indefiniteTime = "somePoint";
									}
									S.getId("timeframe").value = indefiniteTime;
									break;
								case "once":
									S.getId("fullDate").value = item.time.split("~")[0];
									break;
								case "monthly":
									S.getId("day").value = item.time.split("~")[0];
									break;
								case "weekly":
									week.forEach(function (ID) {
										S.getId(ID).checked = false;
									});
									item.time.split("~")[0].trim().split(" ").forEach(function (ID) {
										S.getId(ID).checked = true;
									});
									break;
							}
							if (item.recurrence != "indefinite") {
								if (item.time.split("~")[1].includes(" ")) {
									S.getId("time").value = item.time.split("~")[1].split(" ")[0];
									S.getId("timeFormat").value = item.time.split("~")[1].split(" ")[1];
								} else {
									S.getId("time").value = item.time.split("~")[1];
									S.getId("timeFormat").value = "24-hour";
								}
							}
							if (item.labels) {
								S.getId("labels").value = item.labels.join(", ");
							}
							showHide();
							S.getClass("drop-down")[1].children[1].style.display = "block";
						});
						// listens for touching and holding on a description
						// (pulls up the editor for that item)
						S.onTouchHold(S.getId("list").getElementsByTagName("span")[index], function () {
							if (document.selection && document.selection.empty) {
								document.selection.empty();
							} else if (window.getSelection) {
								window.getSelection().removeAllRanges();
							}
							let item = S.storage[storagePlace].recall(encodeURIComponent(listItem.description));
							S.getId("description").value = listItem.description;
							S.getId("importance").value = item.importance;
							S.getId("recurrence").value = item.recurrence;
							switch (item.recurrence) {
								case "indefinite":
									let indefiniteTime = Number(item.time.split("~")[0]) - now.getTime();
									if (indefiniteTime <= 0) {
										indefiniteTime = "immediately";
									} else if (indefiniteTime <= 250000000) {
										indefiniteTime = "soon";
									} else if (indefiniteTime <= 700000000) {
										indefiniteTime = "later";
									} else if (indefiniteTime <= 1600000000) {
										indefiniteTime = "aWhile";
									} else {
										indefiniteTime = "somePoint";
									}
									S.getId("timeframe").value = indefiniteTime;
									break;
								case "once":
									S.getId("fullDate").value = item.time.split("~")[0];
									break;
								case "monthly":
									S.getId("day").value = item.time.split("~")[0];
									break;
								case "weekly":
									week.forEach(function (ID) {
										S.getId(ID).checked = false;
									});
									item.time.split("~")[0].trim().split(" ").forEach(function (ID) {
										S.getId(ID).checked = true;
									});
									break;
							}
							if (item.recurrence != "indefinite") {
								if (item.time.split("~")[1].includes(" ")) {
									S.getId("time").value = item.time.split("~")[1].split(" ")[0];
									S.getId("timeFormat").value = item.time.split("~")[1].split(" ")[1];
								} else {
									S.getId("time").value = item.time.split("~")[1];
									S.getId("timeFormat").value = "24-hour";
								}
							}
							if (item.labels) {
								S.getId("labels").value = item.labels.join(", ");
							}
							showHide();
							S.getClass("drop-down")[1].children[1].style.display = "block";
						}, false, 300);
					});
				}
				S.getId("recurrence").value = "";
				showHide();
				S.getClass("drop-down")[1].children[1].style.display = "none";
			});

			function remove() {
				let location = S.storage[storagePlace];
				location.list().forEach(function(key) {
					let item = location.recall(key);
					if (key == encodeURIComponent(S.getId("description").value.trim())) {
						location.forget(key);
					} else if (item.done && (item.recurrence == "indefinite" || item.recurrence == "once")) {
						location.forget(key);
					}
				});
				S.getId("description").value = "";
				refresh();
			}

			function cancel() {
				S.forEach(S.getClass("drop-down")[1].children[1].getElementsByTagName("input"), function (input) {
					if (input.type == "checkbox") {
						input.checked = false;
					} else {
						input.value = "";
					}
				});
				S.forEach(S.getClass("drop-down")[1].children[1].getElementsByTagName("select"), function (select) {
					select.value = "";
				});
				showHide();
				S.getClass("drop-down")[1].children[1].style.display = "none";
			}

			S.listen("listFilter", "change", function () {
				if (this.value.trim()) {
					this.parentNode.parentNode.children[0].style.color = "#0a0";
				} else {
					this.parentNode.parentNode.children[0].style.color = "steelblue";
				}
				refresh();
			});
			
			window.addEventListener("finished", function () {
				function startDoingStuff() {
					S.forEach(S.getTag("nav")[0].children, function (section) {  // allows mobile devices to access the drop-down menus
						section.children[0].addEventListener("click", function () {
							if (window.getComputedStyle(section.children[1]).display == "none") {
								section.children[1].style.display = "block";
							} else {
								section.children[1].style.display = "none";
							}
						});
					});

					refresh();
					S.getId("recurrence").addEventListener("change", showHide);
					S.getId("quickSelect").addEventListener("change", function () {
						S.getId("fullDate").value = this.value;
					});
					setInterval(function () {  // refreshes a little under every 17 minutes
						refresh(true);
						let now = new Date();
						let time = now.getHours();
						if (new Date(now.getTime() - dayThreshold * 3600000).getDay() < 5) {  // if it's a week-night
							time += 1;
							if (time == 24) {
								time = 0;
							}
						}
						if (time == 21 && Math.floor(Math.random() * 2) == 0) {
							noisemaker.change("waveform", "sawtooth");
							noisemaker.play("a5--");
						} else if (time == 22) {
							noisemaker.change("waveform", "sawtooth");
							noisemaker.play("a5--");
						} else if (time == 23) {
							noisemaker.change("waveform", "sawtooth");
							noisemaker.play("a5-a5-");
							setTimeout(function () {
								noisemaker.change("waveform", "sawtooth");
								noisemaker.play("a5-a5-");
							}, 500000);
						} else if (time == 0) {
							noisemaker.change("waveform", "sawtooth");
							noisemaker.play("a4ssa5a4ssa5");
							setTimeout(function () {
								noisemaker.change("waveform", "sawtooth");
								noisemaker.play("a4ssa5a4ssa5");
							}, 250000);
							setTimeout(function () {
								noisemaker.change("waveform", "sawtooth");
								noisemaker.play("a4ssa5a4ssa5");
							}, 500000);
							setTimeout(function () {
								noisemaker.change("waveform", "sawtooth");
								noisemaker.play("a4ssa5a4ssa5");
							}, 750000);
						} else if (time == 1) {
							S.forEach(8, function (_, index) {
								setTimeout(function () {
									noisemaker.change("waveform", "sawtooth");
									noisemaker.play("a5a4a5a4");
								}, 125000 * index);
							});
						} else if (time >= 2 && time < dayThreshold && !noisemaker.playing) {
							noisemaker = new S.Sound({ frequency: 660, waveform: "square", changeWave: "sawtooth", modulation: 1, hertzChange: 220 });
							noisemaker.start();
							/*  This is too much fun to make me want to go to bed.
							let playString;
							function addNote() {
								playString += ["a", "b", "c", "d", "e", "f", "g"][Math.floor(Math.random()*7)] + (Math.floor(Math.random()*2) + 4);
							}
							function maybeAddSlur() {
								if (Math.floor(Math.random() * 2) == 0) {
									playString += "s";
								} else {
									addNote();
								}
							}
							setInterval(function () {
								if (Math.floor(Math.random() * 2) == 0) {
									noisemaker.change("waveform", "sawtooth");
								} else {
									noisemaker.change("waveform", "square");
								}
								playString = "";
								addNote();
								maybeAddSlur();
								maybeAddSlur();
								addNote();
								noisemaker.play(playString);
							}, 1205);
							*/
						} else {
							noisemaker.change("waveform", "sine");
							if (now.getMonth() == 11 && Math.ceil(Math.random() * 3) == 3) {  // occasionally plays a part of "We Wish You a Merry Christmas" during December
								noisemaker.play("a4---d5- d5-e5-d5-Db5-b4- b4- b4---e5- e5-F#5-e5-d5-C#5- a4- a4---F#5- F#5-g5-F#5-e5-d5- b4- a4-a4-b4-- e5- Db5- d5---", { noteLength: 75, attack: 30, decay: 30 });
							}
						}
						if (pastDueNumber > 0 && !(time >= 2 && time < dayThreshold)) {
							// makes an audible message for things that are past due
							setTimeout(function () {
								noisemaker.change("waveform", "square");
								noisemaker.play("a5sa4sa5 " + "a5 ".repeat(pastDueNumber));
							}, 15000);
						}
					}, 1000000);  // refreshes a little under every 17 minutes

					firebase.auth().onAuthStateChanged(function (user) {
						if (user) {
							S.getTag("nav")[0].getElementsByTagName("div")[0].getElementsByTagName("button")[0].disabled = false;
							S.getTag("nav")[0].getElementsByTagName("div")[0].getElementsByTagName("button")[1].disabled = false;
							if (S.getId("syncData").checked) {
								mergeData = confirm("Merge this data with your account data?");
								if (mergeData) {  ////
									if (S.storage.session.list().length > 0) {
										S.forEach(S.storage.session.list(), function (key) {
											S.storage.local.store(key, S.storage.session.recall(key));
										});
									}
									deleteData = confirm("Delete account data not present here?");
								}
							}
						} else {
							S.getTag("nav")[0].getElementsByTagName("div")[0].getElementsByTagName("button")[0].disabled = true;
							S.getTag("nav")[0].getElementsByTagName("div")[0].getElementsByTagName("button")[1].disabled = true;
						}
						refresh(true);
					});
				}
				S.makeToneGenerator(true, startDoingStuff, startDoingStuff);
			});

			S.listen("syncData", "change", function () {
				if (S.storage.server.user && this.checked) {
					mergeData = confirm("Merge this data with your account data?");
					if (mergeData) {  ////
						if (S.storage.session.list().length > 0) {
							S.forEach(S.storage.session.list(), function (key) {
								S.storage.local.store(key, S.storage.session.recall(key));
							});
						}
						deleteData = confirm("Delete account data not present here?");
					}
					refresh(true);
				} else {
					refresh();
				}
			});

			S.listen("useLocalStorage", "click", function () {
				if (S.getName("storagePlace", true).id == "useLocalStorage") {
					storagePlace = "local";
				} else {
					storagePlace = "session";
				}
			});

			S.listen("useSessionStorage", "click", function () {
				if (S.getName("storagePlace", true).id == "useLocalStorage") {
					storagePlace = "local";
				} else {
					storagePlace = "session";
				}
			});

			S.listen("soundVolume", "change", function () {
				if (this.value == "") {
					var volume = 100;
				} else if (S.getType(Number(this.value)) == "Number") {
					var volume = Number(this.value);
				}
				if (typeof volume !== "undefined") {
					volume = volume / 100;
					if (noisemaker.playing && noisemaker.hertzChange != 0) {  // if the lateness alarm is constantly going off
						//// console.log("--------");
						//// console.log(noisemaker.playing);
						noisemaker.stop();
						//// console.log(noisemaker.playing);
						noisemaker.change("maxVolume", volume);
						//// console.log(noisemaker.playing);
						noisemaker.start();
						//// console.log(noisemaker.playing);
					} else {
						noisemaker.change("maxVolume", volume);
						noisemaker.play("a5---");
					}
				}
			});

			S.listen("loadSampleList", "click", function () {
				if (this.textContent.trim() == "Load sample list") {
					S.forEach(sampleList, function (item) {
						S.storage.session.store(encodeURIComponent(item.description), { importance: item.importance, time: item.time, recurrence: item.recurrence, lastFinished: item.lastFinished, done: item.done, labels: item.labels });
					});
					S.getId("useSessionStorage").checked = true;
					storagePlace = "session";
					this.textContent = "Remove sample list";
				} else {
					S.forEach(S.storage.session.list(), function (key) {
						S.storage.session.forget(key);
					});
					S.getId("useLocalStorage").checked = true;
					storagePlace = "local";
					this.textContent = "Load sample list";
				}
				S.getClass("drop-down")[0].children[1].style.display = "none";
				refresh();
			});

			S.listen("update", "click", function () {
				if (!this.disabled) {
					/*
					S.storage.local.list().forEach(function(key) {
						S.storage.local.move(key, decodeURIComponent(decodeURIComponent(decodeURIComponent(decodeURIComponent(decodeURIComponent(key))))));
					});
					S.forEach(S.storage.local.list(), function(key) {
						if (key != encodeURIComponent(key)) {
							S.storage.local.store(encodeURIComponent(key), S.storage.local.recall(key));
							S.storage.local.forget(key);
						}
					});
					refresh();
					*/
				}
			});
		</script>
		<link rel="stylesheet" href="https://epicenterprograms.github.io/standards/formatting/foundation.css">
		<!--
		<link rel="stylesheet" href="file:///C:/Users/Robert/Documents/GitHub/standards/formatting/foundation.css">
		-->
		<style>
			main {
				margin-top: 0em;
			}
			nav.top-nav {
				margin: auto;
				width: 90%;
			}
			nav.top-nav td {
				padding: 0em;
			}
			nav.top-nav label {
				white-space: nowrap;
			}
			nav.top-nav div.drop-down div {
				padding: .5em;
			}
			section button {
				margin: 0rem .5rem;
			}
			.list-item {
				margin: .5em 0em;
			}
			.block {
				display: block;
				margin: 1em auto;
			}
			#pastDueNotifier {
				display: none;
				position: relative;
				top: .25em;
				z-index: 1;
				border: 1px solid black;
				border-radius: .75em;
				padding: 0em;
				width: 1.25em;
				height: 1.25em;
				background: red;
				font-size: .75em;
				color: white;
			}
			#pastDueItems {
				display: inline-block;
				position: static;
				padding: .15em 0em 0em;
				height: 1em;
				overflow: hidden;
			}
			#dueTodayItems {
				display: inline-block;
				position: static;
				padding: .15em 0em 0em;
				height: 1em;
				overflow: hidden;
			}
			@media screen and (max-width: 1000px) {
				body {
					font-size: 1.5em;
				}
				main {
					font-size: 1.5em;
				}
				h1 {
					font-size: 3em;
				}
				button {
					font-size: 1.25em;
				}
				label {
					font-size: 1.5em;
				}
				input {
					-ms-transform: scale(1.5);
					-webkit-transform: scale(1.5);
					transform: scale(1.5);
				}
				nav.top-nav div.drop-down div:first-child {
					font-size: 2.25em;
				}
				.user-section {
					display: block;
					position: static;
				}
			}
		</style>
	</head>
	<body>
		<h1 class="main-title">
			To-do List
		</h1>
		<div class="user-section">
			<button id="signIn">
				Log in
			</button>
			<button id="signUp">
				Register
			</button>
			<button id="userSettings">
				Settings
			</button>
			<button id="signOut">
				Log out
			</button>
		</div>
		<nav class="top-nav">
			<div class="drop-down" tabindex="0">
				<div>
					Settings
				</div>
				<div>
					<table class="organizational">
						<tr style="display:none">
							<td><input type="checkbox" id="syncData"></td>
							<td><label for="syncData">Sync data with your account when possible</label></td>
						</tr>
						<tr>
							<td>
								<button onclick="mergeInformation(true)" disabled>
									Copy local to server
								</button>
							</td>
							<td>
								<button onclick="mergeInformation()" disabled>
									Copy server to local
								</button>
							</td>
						</tr>
						<tr>
							<td>
								Store indefinitely
							</td>
							<td>
								Store temporarily
							</td>
						</tr>
						<tr>
							<td>
								<input type="radio" name="storagePlace" id="useLocalStorage" checked>
							</td>
							<td>
								<input type="radio" name="storagePlace" id="useSessionStorage">
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="text" id="soundVolume" placeholder="Volume (1-100)">
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="checkbox" id="inspiringMessages">
								<label for="inspiringMessages">say inspiring messages</label>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<button id="loadSampleList">Load sample list</button>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<button id="update" disabled>
									Run corrections
								</button>
							</td>
						</tr>
					</table>
				</div>
			</div>
			<div class="drop-down" tabindex="0">
				<div>
					Editor
				</div>
				<div>
					<input type="text" class="block" id="description" placeholder="Thing to do" style="margin-top:.5em">
					<input type="text" class="block" id="labels" placeholder="Labels">
					<select class="block" id="importance">
						<option value="" disabled selected>
							Importance
						</option>
						<option value="1">
							1 (lowest)
						</option>
						<option value="2">
							2
						</option>
						<option value="3">
							3
						</option>
						<option value="4">
							4
						</option>
						<option value="5">
							5 (highest)
						</option>
					</select>
					<select class="block" id="recurrence">
						<option value="" disabled selected>
							Recurrence
						</option>
						<option value="indefinite">
							Indefinite
						</option>
						<option value="once">
							One time
						</option>
						<option value="monthly">
							Monthly
						</option>
						<option value="weekly">
							Weekly
						</option>
						<option value="daily">
							Daily
						</option>
					</select>
					<section id="indefinite" style="display:none">
						<select id="timeframe">
							<option value="" disabled selected>
								Timeframe
							</option>
							<option value="immediately">
								Immediately
							</option>
							<option value="soon">
								Soon
							</option>
							<option value="later">
								Later
							</option>
							<option value="aWhile">
								In a while
							</option>
							<option value="somePoint">
								At some point
							</option>
						</select>
					</section>
					<section id="once" style="display:none">
						<input type="text" id="fullDate" placeholder="Date (month/day/year)">
						<select id="quickSelect">
							<option value="" disabled selected>
								Quick select
							</option>
							<option value="monday">
								Monday
							</option>
							<option value="tuesday">
								Tuesday
							</option>
							<option value="wednesday">
								Wednesday
							</option>
							<option value="thursday">
								Thursday
							</option>
							<option value="friday">
								Friday
							</option>
							<option value="saturday">
								Saturday
							</option>
							<option value="sunday">
								Sunday
							</option>
						</select>
					</section>
					<section id="monthly" style="display:none">
						<input type="text" id="day" placeholder="Day of the month">
					</section>
					<section id="weekly" class="list" style="display:none">
						<input type="checkbox" id="monday">
						<label for="monday">Monday</label>
						<br>
						<input type="checkbox" id="tuesday">
						<label for="tuesday">Tuesday</label>
						<br>
						<input type="checkbox" id="wednesday">
						<label for="wednesday">Wednesday</label>
						<br>
						<input type="checkbox" id="thursday">
						<label for="thursday">Thursday</label>
						<br>
						<input type="checkbox" id="friday">
						<label for="friday">Friday</label>
						<br>
						<input type="checkbox" id="saturday">
						<label for="saturday">Saturday</label>
						<br>
						<input type="checkbox" id="sunday">
						<label for="sunday">Sunday</label>
					</section>
					<section id="timeSection" style="display:none">
						<input type="text" id="time" placeholder="Time (hour:minute)">
						<span>&nbsp;</span>
						<select id="timeFormat">
							<option value="" disabled selected>
								Time format
							</option>
							<option value="am">
								am
							</option>
							<option value="pm">
								pm
							</option>
							<option value="24-hour">
								24-hour
							</option>
						</select>
					</section>
					<section>
						<button onclick="include()">
							Add to list
						</button>
						<button onclick="remove()">
							Remove
						</button>
					</section>
					<button class="block" onclick="cancel()">
						Cancel
					</button>
				</div>
			</div>
			<div class="drop-down" tabindex="0">
				<div>
					Filter
				</div>
				<div>
					<input type="text" id="listFilter" placeholder="Filter items">
				</div>
			</div>
			<div class="drop-down" tabindex="0">
				<div>
					Notifications
					<div id="pastDueNotifier"></div>
				</div>
				<div>
					There are
					<div id="pastDueItems">0</div>
					past-due items.
					<br>
					There are
					<div id="dueTodayItems">0</div>
					items due today.
				</div>
			</div>
		</nav>
		<main>
			<div id="list" class="list"></div>
		</main>
	</body>
</html>
